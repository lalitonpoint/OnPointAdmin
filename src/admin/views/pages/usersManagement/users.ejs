<link rel="stylesheet" href="/admin/css/websiteManagement/blogs.css">

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold">âœ¨ User Management</h3>
        <div>
            <button class="btn btn-success me-2" id="downloadAllCsv">
                <i class="fas fa-download me-2"></i> Download CSV
            </button>
            <button class="btn btn-pink" data-bs-toggle="modal" data-bs-target="#userModal">
                <i class="fas fa-plus me-2"></i> Add User
            </button>
        </div>
    </div>

    <div class="card shadow-sm mb-4" id="searchUsersCard">
        <div class="card-body">
            <h5 class="mb-3">Search User</h5>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="searchName" class="form-label">Name</label>
                    <input type="text" class="form-control" id="searchName" placeholder="Search Name">
                </div>
                <div class="col-md-4">
                    <label for="searchEmail" class="form-label">Email</label>
                    <input type="text" class="form-control" id="searchEmail" placeholder="Search Email">
                </div>
                <div class="col-md-4">
                    <label for="searchMobile" class="form-label">Mobile</label>
                    <input type="text" class="form-control" id="searchMobile" placeholder="Search Mobile">
                </div>
                <div class="col-md-3">
                    <label for="searchStatus" class="form-label">Status</label>
                    <select id="searchStatus" class="form-select">
                        <option value="">All</option>
                        <option value="1">Active</option>
                        <option value="2">Inactive</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="SearchDeviceType" class="form-label">Device Type</label>
                    <select class="form-select" id="SearchDeviceType">
                        <option value="">Select Device Type</option>
                        <option value="1">Android</option>
                        <option value="2">IOS</option>
                        <option value="3">Web</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="searchCreatedAt" class="form-label">Created At</label>
                    <input type="date" class="form-control" id="searchCreatedAt">
                </div>
                <div class="col-md-3">
                    <div class="">
                        <label for="&nbsp"></label>
                        <div class="mt-2">
                            <button class="btn btn-primary" id="searchBtn">Search</button>
                            <button class="btn btn-secondary" id="resetBtn">Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <div class="table-responsive">
                    <table id="userTable" class="table table-bordered table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Mobile</th>
                                <th>Profile Picture</th>
                                <th>Device Type</th>
                                <th>Status</th>
                                <th>Created At</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg custom-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <input type="hidden" id="userId">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="name" class="form-label">Name <strong class="text-danger">*</strong></label>
                            <input type="text" class="form-control" id="name" name="fullName"
                                placeholder="Enter User Name">
                        </div>
                        <div class="col-md-6">
                            <label for="email" class="form-label">Email <strong class="text-danger">*</strong></label>
                            <input type="email" class="form-control" id="email" name="emailAddress"
                                placeholder="Enter Email Id">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="country" class="form-label">Country <strong
                                    class="text-danger">*</strong></label>
                            <select class="form-select" id="country" name="country">
                                <option value="">Select Country</option>
                                <option value="+91">India (+91)</option>
                                <option value="+1">United States (+1)</option>
                                <option value="+44">United Kingdom (+44)</option>
                                <option value="+61">Australia (+61)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="mobileNumber" class="form-label">Mobile <strong
                                    class="text-danger">*</strong></label>
                            <input type="text" class="form-control" id="mobileNumber" name="mobileNumber"
                                placeholder="Enter Mobile Number">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="gender" class="form-label">Gender <strong class="text-danger">*</strong></label>
                            <select class="form-select" name="gender" id="gender">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                                <option value="Prefer not to say">Prefer not to say</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="companyName" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="companyName" name="companyName"
                                placeholder="Enter Company Name">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="gstNumber" class="form-label">GST Number</label>
                            <input type="text" class="form-control" id="gstNumber" name="gstNumber"
                                placeholder="Enter GST Number">
                        </div>
                        <div class="col-md-6">
                            <label for="status" class="form-label">Status <strong class="text-danger">*</strong></label>
                            <select class="form-select" name="status" id="status">
                                <option value="">Select Status</option>
                                <option value="1">Active</option>
                                <option value="2">Inactive</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Profile Picture <strong class="text-danger">*</strong></label>
                            <input type="file" class="form-control image_view" name="profilePicture" id="profilePicture"
                                accept="image/*">
                            <div id="imagePreviewContainer" class="mt-2" style="display: none;">
                                <img id="imagePreview" src="#" alt="Profile Image Preview"
                                    style="max-width: 100px; max-height: 100px;">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="deviceType" class="form-label">Device Type <strong
                                    class="text-danger">*</strong></label>
                            <select class="form-select" name="deviceType" id="deviceType">
                                <option value="">Select Device Type</option>
                                <option value="1">Android</option>
                                <option value="2">IOS</option>
                                <option value="3">Web</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-pink w-100">Save</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        // Initially hide search card
        // const searchUsersCard = $('#searchUsersCard');
        // searchUsersCard.hide();

        // $(window).on('load', function () {
        //     searchUsersCard.slideDown(1000);
        // });

        // Image Preview
        $('.image_view').change(function () {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    $('#imagePreview').attr('src', e.target.result);
                    $('#imagePreviewContainer').show();
                }
                reader.readAsDataURL(file);
            } else {
                $('#imagePreview').attr('src', '#');
                $('#imagePreviewContainer').hide();
            }
        });

        // DataTable Setup
        let table = $('#userTable').DataTable({
            processing: true,
            serverSide: true,
            pageLength: 10,
            lengthMenu: [10, 25, 50, 100],
            scrollY: "400px",
            scrollCollapse: true,
            searching: false,
            ajax: {
                url: '/users/usersList', // YOUR actual server route
                type: 'POST',
                data: function (d) {
                    d.fullName = $('#searchName').val();
                    d.emailAddress = $('#searchEmail').val();
                    d.mobileNumber = $('#searchMobile').val();
                    d.status = $('#searchStatus').val();
                    d.deviceType = $('#SearchDeviceType').val();
                    d.createdAt = $('#searchCreatedAt').val();
                }
            },
            columns: [
                {
                    data: null,
                    orderable: false,
                    render: (data, type, row, meta) => meta.row + meta.settings._iDisplayStart + 1
                },
                { data: 'fullName' },
                { data: 'emailAddress' },
                { data: 'mobileNumber' },
                {
                    data: 'profilePicture',
                    orderable: false,
                    render: (data) => data ? `<img src="${data}" class="rounded" width="50" height="50">` : ''
                },
                {
                    data: 'deviceType',
                    orderable: false,
                    render: (data) => {
                        switch (parseInt(data)) {
                            case 1:
                                return 'Android';
                            case 2:
                                return 'IOS';
                            case 3:
                                return 'Web';
                            default:
                                return 'Unknown';
                        }
                    }
                },
                {
                    data: 'status',
                    orderable: false,
                    render: (data, type, row) => {
                        const statusText = data == 1 ? 'Active' : 'Inactive';
                        const newStatus = data == 1 ? 2 : 1;
                        return `<span class="badge ${data == 1 ? 'bg-success' : 'bg-secondary'} changeStatus" data-id='${row._id}' data-status='${newStatus}' style="cursor: pointer;">${statusText}</span>`;
                    }
                },
                {
                    data: 'createdAt', // Created At
                    render: function (data) {
                        return moment(data).format('YYYY-MM-DD HH:mm:ss'); // Format the date as needed
                    }
                }, {
                    data: null,
                    orderable: false,
                    render: (data, type, row) => `
                        <button class="btn btn-sm btn-primary editUser" data-id="${row._id}">Edit</button>
                        <button class="btn btn-sm btn-danger deleteUser" data-id="${row._id}">Delete</button>
                    `
                }
            ]
        });

        $('#userForm').on('submit', function (e) {
            e.preventDefault();
            const formElement = document.getElementById('userForm');
            const id = $('#userId').val();


            if (formElement) {
                let isValid = true;

                const country = $('#country').val();
                const fullName = $('#name').val().trim();
                const mobileNumber = $('#mobileNumber').val().trim();
                const email = $('#email').val().trim();
                const gender = $('#gender').val();
                const status = $('#status').val();
                let profilePicture = $('#profilePicture').val();
                const deviceType = $('#deviceType').val();
                if (id && $('#imagePreview').attr('src') != '#')
                    profilePicture = $('#imagePreview').attr('src');
                // alert(profilePicture)

                // Validation
                if (!fullName) {
                    toastr.error('Please Enter Full Name', 'Error');
                    isValid = false;
                    return;
                }

                if (!email) {
                    toastr.error('Please Enter Email', 'Error');
                    return;
                } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { // Simple email regex
                    toastr.error('Enter a valid Email address.', 'Error');
                    return;
                }

                if (!country) {
                    toastr.error('Please Select Country', 'Error');
                    return;
                }

                if (!mobileNumber) {
                    toastr.error('Please Enter Mobile Number', 'Error');
                    return;
                } else if (!/^\d{7,15}$/.test(mobileNumber)) { // Example: Mobile should be 7-15 digits
                    toastr.error('Enter a valid Mobile Number.', 'Error');
                    return;
                }

                if (!gender) {
                    toastr.error('Please Select Gender', 'Error');
                    return;
                }
                if (!status) {
                    toastr.error('Please Select Status', 'Error');
                    return;
                }
                if (!profilePicture) {
                    toastr.error('Please Choose Profile Picture', 'Error');
                    return;
                }
                if (!deviceType) {
                    toastr.error('Please Select Device Type', 'Error');
                    return;
                }


                const formData = new FormData(formElement);
                const actionUrl = id ? '/users/updateUser/' + id : '/users/saveUserdata'; // Replace with your actual routes


                $.ajax({
                    url: actionUrl,
                    type: 'post',
                    data: formData,
                    processData: false,
                    contentType: false,
                    dataType: 'json',
                    success: function (response) {
                        toastr.success(response.message, 'Success');
                        $('#userForm')[0].reset();
                        $('.btn-close').click();
                        table.ajax.reload();
                    },
                    error: function (xhr, status, error) {
                        console.error("AJAX request failed:", status, error, xhr);
                        toastr.error('An error occurred while submitting the form.', 'Error');
                    }
                });
            } else {
                console.error("Error: The form element with ID 'userForm' was not found.");
            }
        });


        $('#userModal').on('show.bs.modal', function (event) {
            const button = $(event.relatedTarget); // Button that triggered the modal
            const id = button.data('id'); // Extract info from data-* attributes
            const modalTitle = $('#modalTitle');
            const userId = $('#userId');
            const form = $('#userForm')[0];
            const imagePreview = $('#imagePreview');
            const imagePreviewContainer = $('#imagePreviewContainer');

            form.reset(); // Reset the form every time the modal is shown
            userId.val('');
            imagePreview.attr('src', '#');
            imagePreviewContainer.hide();
            modalTitle.text('Add User');

            if (id) {
                modalTitle.text('Edit User');
                userId.val(id);
                // Fetch blog data and populate the form for editing
                $.ajax({
                    url: '/users/getUser/' + id, // Replace with your actual route
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        $('#name').val(data.fullName);
                        $('#email').val(data.emailAddress);
                        $('#country').val(data.countryCode);
                        $('#mobileNumber').val(data.mobileNumber);
                        $('#gender').val(data.gender);
                        $('#companyName').val(data.companyName);
                        $('#gstNumber').val(data.gstNumber);
                        $('#status').val(data.status);
                        $('#deviceType').val(data.deviceType);

                        if (data.profilePicture) {
                            imagePreview.attr('src', data.profilePicture);
                            imagePreviewContainer.show();
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error fetching blog:", status, error, xhr);
                        toastr.error('Error fetching blog data for editing.', 'Error');
                    }
                });
            }
        });

        // Event delegation for Edit button
        $('#userTable').on('click', '.editUser', function () {
            const blogId = $(this).data('id');
            $('#userModal').modal('show', this); // Pass the button element for context
        });

        // Search button
        $('#searchBtn').click(function () {
            table.ajax.reload();
        });
        // $('.btn-close').click(function () {
        //     window.location.reload();
        // });


        // Reset button
        $('#resetBtn').click(function () {
            $('#searchName, #searchStatus, #searchCreatedAt').val('');
            table.ajax.reload();
        });
        $('#downloadAllCsv').on('click', function () {
            window.location.href = '/users/downloadAllCsv'; // Replace with your actual route
        });

        $('#userTable').on('click', '.deleteUser', function () {
            const userId = $(this).data('id');

            swalConfirm('Are you sure you want to delete this user?', function () {
                $.ajax({
                    url: '/users/deleteUser/' + userId, // Replace with your actual delete route
                    type: 'POST',  // Ensure the correct HTTP method is used
                    dataType: 'json',
                    success: function () {
                        table.ajax.reload();
                        toastr.success('User deleted successfully!', 'Success');
                    },
                    error: function (xhr, status, error) {
                        console.error("Error deleting User:", status, error, xhr);
                        toastr.error('Error deleting User.', 'Error');
                    }
                });
            });
        });

        $('#userTable').on('click', '.changeStatus', function () {
            const userId = $(this).data('id');
            const newStatus = $(this).data('status'); // Get the new status from the data attribute
            const statusText = parseInt(newStatus) === 1 ? 'Active' : 'Inactive'; // For confirmation message

            if (confirm(`Are you sure you want to set the status to ${statusText}?`)) {
                $.ajax({
                    url: '/users/changeStatus/' + userId, // Replace with your actual route
                    type: 'post',
                    dataType: 'json',
                    contentType: 'application/json', // Important for sending JSON data in the body
                    data: JSON.stringify({ status: newStatus }), // Send the new status in the request body
                    success: function (response) {
                        if (response.success) {
                            table.ajax.reload();
                            toastr.success(response.message, 'Success');
                        } else {
                            toastr.error(response.message || 'Failed to change status.', 'Error');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error changing status:", status, error, xhr);
                        toastr.error('Error changing status.', 'Error');
                    }
                });
            }
        });
    });
</script>